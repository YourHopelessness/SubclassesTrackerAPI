name: Build and Deploy Backend (Aspire, API, Cleaner)

on:
  workflow_dispatch:
  push:
    tags:
      - 'backend-release-*'

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Restore
      - name: Restore dependencies
        run: dotnet restore SubclassesTrackerExtension.sln

  publish:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Publish API
      - name: Publish API
        run: dotnet publish SubclassesTracker.Api/SubclassesTracker.Api.csproj -c Release -o publish/api

      # Publish Cleaner
      - name: Publish Cleaner
        run: dotnet publish SubclassesTracker.CleanupService/SubclassesTracker.CleanupService.csproj -c Release -o publish/cleaner

      # Publish Aspire Host
      - name: Publish Aspire AppHost
        run: dotnet publish SubclassesTracker.AspireHost/SubclassesTracker.AspireHost.csproj -c Release -o publish/apphost

      # Upload combined artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: subclasses-backend
          path: backend/publish

  deploy:
    needs: publish
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: subclasses-backend
          path: backend/publish

      # Copy each part separately
      - name: Stop services before update
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.YOKO_HOST }}
          username: ${{ secrets.YOKO_USER }}
          key: ${{ secrets.YOKO_KEY }}
          script: |
            sudo systemctl stop subclasses-api || true
            sudo systemctl stop subclasses-cleaner || true
            sudo systemctl stop subclasses-aspire || true

      # API
      - name: Deploy API
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.YOKO_HOST }}
          username: ${{ secrets.YOKO_USER }}
          key: ${{ secrets.YOKO_KEY }}
          source: "backend/publish/api/*"
          target: ${{ secrets.YOKO_API_TARGET }}
          strip_components: 1
          rm: true

      # Cleaner
      - name: Deploy Cleaner
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.YOKO_HOST }}
          username: ${{ secrets.YOKO_USER }}
          key: ${{ secrets.YOKO_KEY }}
          source: "backend/publish/cleaner/*"
          target: ${{ secrets.YOKO_CLEANER_TARGET }}
          strip_components: 1
          rm: true

      # Aspire Host
      - name: Deploy Aspire Host
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.YOKO_HOST }}
          username: ${{ secrets.YOKO_USER }}
          key: ${{ secrets.YOKO_KEY }}
          source: "backend/publish/apphost/*"
          target: ${{ secrets.YOKO_ASPIRE_TARGET }}
          strip_components: 1
          rm: true

      - name: Restart services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.YOKO_HOST }}
          username: ${{ secrets.YOKO_USER }}
          key: ${{ secrets.YOKO_KEY }}
          script: |
            sudo systemctl start subclasses-aspire
            sudo systemctl start subclasses-api
            sudo systemctl start subclasses-cleaner
            sudo systemctl status subclasses-aspire --no-pager
            sudo systemctl status subclasses-api --no-pager
            sudo systemctl status subclasses-cleaner --no-pager
